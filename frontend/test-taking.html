<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Arial', sans-serif;
            background: #f8f9fa;
            color: #333;
        }
        .header {
            background: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-links a {
            margin-left: 20px;
            color: #3498db;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 5px;
            transition: background 0.3s ease;
        }
        .nav-links a:hover {
            background: #ecf0f1;
        }
        .test-header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .test-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .test-meta {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            color: #7f8c8d;
        }
        .methodology-badge {
            background: #3498db;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
        }
        .progress-bar {
            background: #ecf0f1;
            height: 8px;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress {
            background: #27ae60;
            height: 100%;
            transition: width 0.3s ease;
        }
        .question-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .question-number {
            color: #3498db;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .question-text {
            font-size: 1.2em;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .option {
            padding: 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .option:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }
        .option.selected {
            border-color: #27ae60;
            background: #d5f4e6;
        }
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        .btn {
            padding: 12px 25px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .btn.submit {
            background: #27ae60;
        }
        .btn.submit:hover {
            background: #219a52;
        }
        .auth-required {
            background: #fdebd0;
            color: #e67e22;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-top: 50px;
            border-left: 4px solid #e67e22;
        }
        .auth-required a {
            color: #3498db;
            font-weight: bold;
            text-decoration: none;
        }
        .auth-required a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="nav">
                <h1>üß™ –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞</h1>
                <div class="nav-links">
                    <a href="/tests">‚Üê –ù–∞–∑–∞–¥ –∫ —Ç–µ—Å—Ç–∞–º</a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
        <div id="authRequired" class="auth-required" style="display: none;">
            <h2>–î–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</h2>
            <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–µ—Å—Ç–∞–º.</p>
            <p>
                <a href="/login">–í–æ–π—Ç–∏</a> | 
                <a href="/register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a> | 
                <a href="/">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            </p>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏) -->
        <div id="testContent" style="display: none;">
            <div class="test-header">
                <h1 id="testTitle">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–∞...</h1>
                <p id="testDescription"></p>
                <div class="test-meta">
                    <span>‚ùì <span id="totalQuestions">0</span> –≤–æ–ø—Ä–æ—Å–æ–≤</span>
                    <span>‚è±Ô∏è <span id="estimatedTime">0</span> –º–∏–Ω—É—Ç</span>
                    <span class="methodology-badge" id="methodologyBadge">–ú–µ—Ç–æ–¥–∏–∫–∞</span>
                </div>
                <div class="progress-bar">
                    <div class="progress" id="progress" style="width: 0%"></div>
                </div>
                <div>–í–æ–ø—Ä–æ—Å <span id="currentQuestion">1</span> –∏–∑ <span id="totalQuestionsCount">0</span></div>
            </div>

            <div id="testForm">
                <div class="question-card">
                    <div class="question-number">–í–æ–ø—Ä–æ—Å <span id="questionNumber">1</span></div>
                    <div class="question-text" id="questionText">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–∞...</div>
                    
                    <div class="options" id="optionsContainer">
                        <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>

                    <div class="navigation">
                        <button type="button" class="btn" id="prevBtn" onclick="previousQuestion()" disabled>‚Üê –ù–∞–∑–∞–¥</button>
                        <button type="button" class="btn" id="nextBtn" onclick="nextQuestion()">–î–∞–ª–µ–µ ‚Üí</button>
                        <button type="button" class="btn submit" id="submitBtn" onclick="submitTest()" style="display: none;">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentQuestionIndex = 0;
        let answers = {};
        let testData = {};

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');

            if (!token || !user.email) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                document.getElementById('authRequired').style.display = 'block';
                return;
            }

            // –ï—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
            document.getElementById('testContent').style.display = 'block';

            // –ü–æ–ª—É—á–∞–µ–º ID —Ç–µ—Å—Ç–∞ –∏–∑ URL
            const pathParts = window.location.pathname.split('/');
            const testId = pathParts[pathParts.length - 1];
            
            if (!testId || isNaN(testId)) {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–µ—Å—Ç–∞');
                window.location.href = '/tests';
                return;
            }

            loadTestData(testId);
        });

        function loadQuestion(index) {
            if (!testData.questions || index >= testData.questions.length) {
                return;
            }

            const question = testData.questions[index];
            const questionOrder = question.order_index || (index + 1); // –ò—Å–ø–æ–ª—å–∑—É–µ–º order_index –µ—Å–ª–∏ –µ—Å—Ç—å
            
            document.getElementById('questionNumber').textContent = index + 1;
            document.getElementById('questionText').textContent = question.question_text;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, optionIndex) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = `option ${answers[questionOrder] === option.id ? 'selected' : ''}`;
                optionDiv.textContent = option.text || option.option_text;
                optionDiv.onclick = () => selectOption(questionOrder, option.id);
                optionsContainer.appendChild(optionDiv);
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            const progress = ((index + 1) / testData.questions.length) * 100;
            document.getElementById('progress').style.width = `${progress}%`;
            document.getElementById('currentQuestion').textContent = index + 1;

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∞–º–∏
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').style.display = index === testData.questions.length - 1 ? 'none' : 'block';
            document.getElementById('submitBtn').style.display = index === testData.questions.length - 1 ? 'block' : 'none';
        }

        function selectOption(questionOrder, optionId) {
            answers[questionOrder] = optionId;
            loadQuestion(currentQuestionIndex); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π
        }

        function nextQuestion() {
            if (currentQuestionIndex < testData.questions.length - 1) {
                currentQuestionIndex++;
                loadQuestion(currentQuestionIndex);
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion(currentQuestionIndex);
            }
        }

        function submitTest() {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

            if (Object.keys(answers).length !== testData.questions.length) {
                if (!confirm('–í—ã –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã. –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç?')) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç';
                    return;
                }
            }

            const submission = {
                answers: answers
            };

            console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –æ—Ç–≤–µ—Ç—ã:', submission); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

            // –°–æ–∑–¥–∞–µ–º AbortController –¥–ª—è —Ç–∞–π–º–∞—É—Ç–∞
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);

            fetch(`/api/tests/${testData.id}/submit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify(submission),
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.result && data.result.interpretation) {
                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
                    window.location.href = `/test-result?interpretation=${encodeURIComponent(data.result.interpretation)}&passed=${data.result.is_passed}&title=${encodeURIComponent(data.result.test_title)}`;
                } else {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                console.error('Error submitting test:', error);
                
                let errorMessage = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç–µ—Å—Ç–∞: ';
                if (error.name === 'AbortError') {
                    errorMessage += '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è';
                } else {
                    errorMessage += error.message;
                }

                alert(errorMessage);
                submitBtn.disabled = false;
                submitBtn.textContent = '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç';
            });
        }

        function getMethodologyLabel(methodology) {
            const labels = {
                'rigidity_scale': '–ú–µ—Ç–æ–¥–∏–∫–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è —Ä–∏–≥–∏–¥–Ω–æ—Å—Ç–∏',
                'willpower_control': '–û–ø—Ä–æ—Å–Ω–∏–∫ –≤–æ–ª–µ–≤–æ–≥–æ —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è',
                'personality_16pf': '16PF –ª–∏—á–Ω–æ—Å—Ç–Ω—ã–π –æ–ø—Ä–æ—Å–Ω–∏–∫'
            };
            return labels[methodology] || methodology;
        }

        function loadTestData(testId) {
            fetch(`/api/tests/${testId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('–¢–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
                return response.json();
            })
            .then(data => {
                testData = data.test;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ—Å—Ç–µ
                document.getElementById('testTitle').textContent = testData.title;
                document.getElementById('testDescription').textContent = testData.description;
                document.getElementById('totalQuestions').textContent = testData.questions.length;
                document.getElementById('totalQuestionsCount').textContent = testData.questions.length;
                document.getElementById('estimatedTime').textContent = testData.estimated_time;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ –º–µ—Ç–æ–¥–∏–∫–∏
                const methodologyBadge = document.getElementById('methodologyBadge');
                methodologyBadge.textContent = getMethodologyLabel(testData.methodology_type);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
                loadQuestion(0);
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ—Å—Ç–∞: ' + error.message);
                window.location.href = '/tests';
            });
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }
    </script>
</body>
</html>